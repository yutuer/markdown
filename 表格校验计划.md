#### 表格校验修改 v1

---

首先分成服务端使用者(我们)和非服务端来处理

修改打表bat, 将检查代码bat调用 放到表数据入库和生成代码之后

修改检查代码bat, 执行如下步骤

1. 判断当前ip是否在服务器端的ip list里面(写死..), 如果不在
   1. 非服务器端使用mmo.jar的classpath. 每次更新jar之后打表, 能保证表结构和jar中一致
2. 如果在, 则说明是服务端
   1. 拷贝生成之后的新的表代码(com.game2sky.xxx.xx.xx.dict 下的java文件)到xx目录(先无差别拷贝, 以后会记录变更)
   2. 将各人idea项目编译后的class目录作为 classpath, 使用 javac重新编译xx目录到指定目录target
   3. 将检查代码的classpath 由mmo.jar改变为target和各人idea项目编译后的class目录(为了有可能新增的enum, 不打mmo.jar)
3. 执行检查代码bat

---

#### 表格校验修改 v2(可选, 好像dict目录全部重新编译也不会慢多少)

服务器端使用者的脚本中 增加版本比对. 

使用1个文件记录原来的dictxxConfig, dictxx, dictxxData 的 md5校验和. 当发现不一致的文件后单独执行javac





打表的时候启动检查, 因为要load新数据, 所以需要先有新的dict.java(需要先生成dict文件), 需要有服务器配合的新的data.java(否则可能报错), 以及data.java依赖的其他.

后台定时打表检查阶段. 这个是放在哪里? 也需要上面的部分.. 

如果考虑策划会修改列, 需要先生成文件, 并且同步最新的data.java以及依赖. 最后要解决的就是后面的2个
对于dict和data, 在打表或者定时检查的时候, 会拷贝最新的服务器下的目录过来(看看好不好实现), 重新编译后检查. 对于依赖, 这个暂时没啥好办法. mmo.jar太大了. 
但是如果是拷贝dict和data的话, 那么npcai的逻辑其实是要检查的.也需要mmo.jar





 旧的表 -> 旧的数据库数据 ,  需要用同样旧的dict.java, data.java去加载   使用旧的java文件, 新的mmo.jar没有问题 因为一般来说新的mmo.jar会有只会添加新的enum依赖, 不会删除

新的表 -> 新的数据库数据,  需要用新的dict.java, data.java去加载, 新的mmo.jar没有问题.  



后续.  

因为打表工具会先先根据表结构, 生成dict文件, 然后将excel数据读入内存.

则 

1. **可以直接从表数据, 转化为dict数据.  先校验再插入数据库**  
2. 表的第一行去掉



TODO 改成 shell的

可以根据提交的版本库, 来指定需要加载的dict类. 以及dict注解定义的关联的其他的dict类. 尽可能减少加载时间 









### 自动更新流程

最初环境: 一份能正常跑起来的mmo.jar, 一个与之匹配的excel文件夹

名次定义:

1. 时机1:  定时检查任务执行点. **只会检查是否有表可以更新, 不会检查mmo.jar是否可以更新**
2. 时机2:  定时任务发现有需要处理的逻辑后. 开始等待一定时间(如果发现有lock文件, 缩短等待时间) 执行检查逻辑. 
   1. 这个时间中可以提交新的表数据以及mmo.jar包, 出错了就走出错的处理
3. 时机3:  执行检查逻辑

策划流程: 提交表

校验流程: 

1. 时机1的时候, **定时检查excel文件夹是否有更新或者lock文件(lock文件表示上次更新没有成功).** 如果有. 则在时机3的时候触发检查下面的逻辑

2. 根据excel表结构, 得到最新java文件(得不到最新的class, 没有最新的mmo.jar编译不了)   和一个能编译生成的临时的插入数据库使用的class(只会有表中的服务器相关字段)

3. 为了直接校验新表数据, 需要能够使用相关的data.class来生成实例加载. 

   1.  要使用data.class, 则依赖于data.class相关的dict.class, 以及相应的依赖类. **所以我们需要原来的旧的mmo.jar包**
   2.  **新数据往旧的data.class装配的时候. 可能会有如下问题**
      1. 缺少字段.   策划删除或者将字段改名了(装配类的时候, class反射就会报出哪列缺失错误,  给excelTools引入excel-game-check包. 将错误**通过邮件**发送给吴延鹏[或者服务器])
      2. 校验规则的报错. 
         1.  策划可能和服务器商量了新的约定, 但是因为是旧的jar包, 所以数据不匹配(检查的时候会报错, 并发送邮件)
         2.  策划填错了数据.  (检查的时候会报错, 并发送邮件)
      3. 如果增加了新的表, 那么无法检查这个新表的数据是否正确.  需要等待下一次包含这个表对应的data.class(或者dict.class)的mmo.jar包
      4. ***上述流程走完. 如果顺利. 则检查表数据流程结束***.  删除lock文件

4. ##### 下面的流程是如何保持mmo.jar与这个新的excel表文件夹数据匹配

   1. 有3个方法. 被动更新, 自己编译, 定时拉取  目前3为主, 1为辅, 2不考虑
   2. 手动更新.(补漏)
      1.  发现上面的流程有报错后, 并且确认是因为mmo.jar太旧了. 则需要将新的mmo.jar编译完成
      2. 需要手动用新表, 新的dict.class, 新的data.class打出一个新的mmor.jar并上传
      3. 手动更新mmo.jar. 等待自动检查程序触发
   3. 自己编译(暂时不考虑)
      1. 时机1的时候
         1. 没有lock文件, 说明上次更新完成. 并且检查正确  
         2. 同时也没有excel更新的时候, 说明表数据稳定.  
         3. 更新protocal协议. 查看是否有更新. 否则执行protocal.bat, 打协议
         4. 更新mmo项目代码. 查看是否有更新
         5. 执行excel.bat 打表. 最新的dict.java, 拷贝进mmo项目
         6. 对mmo项目 进行打包为最新的mmo.jar
      2. 坏处是, 打包时间太长, 会拖慢检查结构.
      3. 好处是 会自动得到一个最新的mmo.jar
   4. 定时拉取. (优先)
      1. 时机1的时候
         1.  没有lock文件, 说明上次更新完成. 并且检查正确 
         2.  同时也没有excel更新的时候, 说明表数据稳定
            1. 如果这个时候服务器修改了校验规则.(太少见了). 这样在下次策划提交表数据时候, 可能会导致校验出错
      2. 每次拉取后执行一次是否和当前的excel文件夹数据的校验(**不能更新excel文件夹**), 可以提前将上面的校验问题预先暴露出来
      3. 坏处是 mmo.jar需要人工生成, 不即时
      4. 好处是处理的快, 不用打包那么多流程

  

![更新流程](D:\chromeDownload\更新流程.png)



### **4个jar**

1. 老的excelTools执行生成并拷贝dict.java. 读取excel数据, 生成数据库数据内容
   1.  啥子都不依赖, 只需要excel目录
2. 拆分出新的excelTools支持将excel数据直接读取进data.class中进行检查
   1.  依赖game-checker来进行邮件或者浏览器的警告(配置),
   2.  依赖mmo.jar,  script.jar 进行check. 
3. game-checker 支持出错误时的发送功能(可选邮件或者浏览器)      (要使用mmo.jar的checker规则的时候, 移除掉dict目录. 要使用自己checker规则的时候加回dict目录, 并放在mmo.jar前面)
   1. 需要替换掉BPLog里面的log为LogWrapper. 所以 2.1一定要在2.2前面

4. CircleChecker(定时检查任务)执行上图的流程
   1. 依赖新的excelTools来进行checker.  **启动时不需要依赖mmo.jar和script.jar, 因为只有校验的时候才需要**



### 策划启动StartServer流程

最初环境: 一份svn最新的mmo.jar. 一份最新的excel目录, 三个脚本bat

1. 启动服务器

   1. 没啥好说的, 服务器启动的流程. 数据库读出数据, 和mmo.jar中的data.class进行init校验. 成功后启动服务器
2. 打表并启动服务器
3. 全量打表并启动服务器

   1. 上面2个一起说
      1. 需要跳过生成并拷贝dict.java的过程.(原来脚本自带功能)
      2. 会先使用mmo.jar和excel目录进行check, 成功后走 1.1 的流程. 不成功则**给操作人弹出浏览器警告** (jar2)
      3. 使用动态编译的简化的dict.class来读取excel插入数据, (见 jar 1)
      4. 启动服务器

4. 新增加一个只读表检查, 不启动服务器的脚本



id重复需要加到excel读取校验中